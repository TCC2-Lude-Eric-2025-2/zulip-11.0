name: Lightweight CI (SonarCloud + Codecov)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: "${{ github.workflow }}-${{ github.head_ref || github.run_id }}"
  cancel-in-progress: true

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  sonar-coverage-light:
    name: Lightweight SonarCloud Coverage (Backend Only)
    runs-on: ubuntu-latest
    
    container: zulip/ci:jammy 
    
    env:
      HOME: /home/github/
      OS_MATRIX_VAR: jammy 

    steps:
      # 1. Checkout
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Criar diretórios de cache
      - name: Create cache directories
        run: |
          dirs=(/srv/zulip-emoji-cache)
          sudo mkdir -p "${dirs[@]}"
          sudo chown -R github "${dirs[@]}"

      # 3. Restaurar Caches
      - name: Restore pnpm store
        uses: actions/cache@v4
        with:
          path: /__w/.pnpm-store
          key: v1-pnpm-store-${{ env.OS_MATRIX_VAR }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Restore uv cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ env.OS_MATRIX_VAR }}-${{ hashFiles('uv.lock') }}
          restore-keys: uv-${{ env.OS_MATRIX_VAR }}-

      - name: Restore emoji cache
        uses: actions/cache@v4
        with:
          path: /srv/zulip-emoji-cache
          key: v1-emoji-${{ env.OS_MATRIX_VAR }}-${{ hashFiles('tools/setup/emoji/emoji_map.json', 'tools/setup/emoji/build_emoji', 'tools.setup/emoji/emoji_setup_utils.py', 'tools/setup/emoji/emoji_names.py', 'package.json') }}
          restore-keys: v1-emoji-${{ env.OS_MATRIX_VAR }}

      # 4. Instalar dependências
      - name: Install dependencies
        run: |
          ./tools/ci/setup-backend --skip-dev-db-build
          scripts/lib/clean_unused_caches.py --verbose --threshold=0

      # 5. ETAPA DE NODE TEST REMOVIDA

      # 6. Rodar testes de Backend (Limpo)
      - name: Run backend tests for coverage
        run: |
          source tools/ci/activate-venv
          ./tools/test-backend --coverage --xml-report --no-html-report --include-webhooks --include-transaction-tests --no-cov-cleanup --ban-console-output

      # 7. Enviar cobertura para o Codecov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: var/coverage.xml
          token: ${{ secrets.CODECOV_TOKEN }} # Adicione este secret no seu fork
          fail_ci_if_error: true

      # 8. Enviar análise para o SonarCloud (SEM COBERTURA, COM 'sonar.sources')
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_CLOUD_TOKEN }} 
        with:
          args: >
            -Dsonar.projectKey=TCC2-Lude-Eric-2025-2_zulip-11.0
            -Dsonar.organization=tcc2-lude-eric-2025-2
            -Dsonar.python.version=3.10
            -Dsonar.sources=analytics,confirmation,corporate,pgroonga,web,zerver,zilencer,zproject